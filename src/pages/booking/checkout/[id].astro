---
import Main from '@/layout/Main.astro';
export const prerender = false;
import { getLangFromRequest, useTranslations } from '@/i18n';
import { Text } from '@/ui-library/components/ssr/text/Text';
import { Divider } from '@/ui-library/components/ssr/divider/Divider';
import { Avatar } from '@/ui-library/components/ssr/avatar/Avatar';
import { Space } from '@/ui-library/components/ssr/space/Space';
import { Chip } from '@/ui-library/components/ssr/chip/Chip';
import { Icon } from '@/ui-library/components/ssr/icon/Icon';
import { DateTime } from '@/features/shared/utils/dateConfig';
import { getSession } from 'auth-astro/server';
import { AnyclazzMyBookingsRepository } from '@/features/bookings/infrastructure/AnyclazzMyBookingsRepository';
import { BookingCheckoutWrapper } from '@/features/bookings/components/booking-checkout/BookingCheckoutWrapper';
import { proficiencyLevels } from '@/features/teachers/onboarding/data/proficiencyLevels';
import { isSuperTutor } from '@/features/teachers/utils/superTutorHelpers';

const lang = getLangFromRequest(Astro.request, Astro.url);
const t = useTranslations({ lang });

const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/teachers');
}

const session = await getSession(Astro.request);
const accessToken = session?.accessToken as string;

if (!accessToken) {
    return Astro.redirect('/login');
}

const teacherRepository = new AnyclazzMyBookingsRepository();
const booking = await teacherRepository.getBookingById({ 
    token: accessToken,
    bookingId: id 
});

// Verificar que el booking tiene el payment data necesario
if (!booking.payment?.clientSecret) {
    console.error('Booking does not have payment data:', booking);
    return Astro.redirect('/teachers');
}

const dateFormatted = (datetime: string) => {
	return DateTime.fromISO(datetime).toLocaleString(DateTime.DATE_FULL);
};

const timeFormatted = (datetime: string) => {
	return DateTime.fromISO(datetime).toFormat('HH:mm ZZZZ')
};

const durationFormatted = (startAt: string, endAt: string) => {
	const start = DateTime.fromISO(startAt);
	const end = DateTime.fromISO(endAt);
	const diffInMinutes = end.diff(start, 'minutes').minutes;
	return t('common.minutes_long', { minutes: diffInMinutes });
};

// Helper para obtener el nombre del nivel de proficiencia
const getProficiencyLevelName = (code: string) => {
    const level = proficiencyLevels.find(l => l.code === code);
    return level ? level.name[lang] : code;
};

---

<Main>
	<div class="flex flex-col p-6 overflow-y-auto h-full">
		{/* Title */}
		<Text size="display-xs" colorType="primary" weight="semibold">{t('booking.checkout')}</Text>
		<Divider margin={16} />
		<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
			<div class="flex flex-col w-full gap-5">
				<div class="flex flex-col w-full card rounded-xl p-5">
					<div class="flex flex-row items-left">
						<Avatar src={booking.teacher.avatar} alt={`${booking.teacher.name} ${booking.teacher.surname}`} size={72} hasVerifiedBadge={isSuperTutor(booking.teacher?.superTutorTo)} hasOutline />
					</div>
					<Space size={16} direction="vertical"/>
					<div class="flex flex-row gap-4">
                        <Text textLevel="h2" size="display-xs" weight="semibold" colorType="primary">{booking.teacher.name}{' '}{booking.teacher.surname}</Text>
                        {isSuperTutor(booking.teacher?.superTutorTo) && (
                            <Chip colorType="primary" rounded>
                                <Icon icon="verified" iconWidth={16} iconHeight={16} />
                                <Text size="inherit" textLevel="span" weight="medium" colorType="accent">{t('teachers.super-tutor')}</Text>
                            </Chip>
                        )}
                    </div>
                    <Space size={10} direction="vertical"/>
                    <!-- <div class="flex flex-row gap-4">
                        <TextWithIcon icon="star" textLevel="span" weight="medium" colorType="primary">{teacher.rating?.toFixed(1)??0}</TextWithIcon>
                        <Text colorType="tertiary" textLevel="span">{teacher.reviewsNumber}{' '}{t('common.reviews')}</Text>
                        <TextWithIcon icon="people" textLevel="span" colorType="tertiary">{teacher.studentsNumber}{' '}{t('common.students')}</TextWithIcon>
                        <TextWithIcon icon="book" textLevel="span" colorType="tertiary">{teacher.lessonsNumber}{' '}{t('common.lessons')}</TextWithIcon>
                    </div> -->
                    <Space size={16} direction="vertical"/>
                    <div class="flex flex-row gap-4">
                        <Text className="w-[64ch] text-ellipsis overflow-hidden whitespace-nowrap" colorType="tertiary" size="text-md">{booking.teacher.shortPresentation}</Text>
                    </div>
                    <Space size={16} direction="vertical"/>
                    <div class="flex flex-row gap-4">
                        <Chip colorType="secondary">
                            <Text colorType="secondary" textLevel="span" size="inherit" weight="medium">{booking.teacher.subject.name[lang]}</Text>
                        </Chip>
                    </div>
                    <Space size={16} direction="vertical"/>
                    <div class="flex flex-row gap-4">
                        <Text colorType="tertiary" size="text-sm">
                            {t('teachers.speaks')}{' '}
                            {booking.teacher.speaksLanguages.map((language) => (
                                `${t(`common.language.${language.language}`)} (${getProficiencyLevelName(language.proficiencyLevel)})`
                            )).join(', ')}
                        </Text>
                    </div>
                </div>
				<div class="flex flex-col gap-4 w-full card rounded-xl p-5">
					<Text weight="medium" colorType="primary">{t('booking.lesson_details')}</Text>
					<div class="flex flex-col gap-1.5 w-full">
						<div class="flex flex-row justify-between">
							<Text>{t('common.date')}</Text>
							<!-- <Text weight="medium" colorType="primary">Sunday, August 24, 2025</Text> -->
							<Text weight="medium" colorType="primary">{dateFormatted(booking.startAt)}</Text>
						</div>
						<div class="flex flex-row justify-between">
							<Text>{t('common.time')}</Text>
							<Text weight="medium" colorType="primary">{timeFormatted(booking.startAt)}</Text>
						</div>
						<div class="flex flex-row justify-between">
							<Text>{t('common.duration')}</Text>
							<Text weight="medium" colorType="primary">{durationFormatted(booking.startAt, booking.endAt)}</Text>
						</div>
						<div class="flex flex-row justify-between">
							<Text>{t('common.lesson_type')}</Text>
							<Text weight="medium" colorType="primary">{t(`classtype.${booking.classTypeId}`)}</Text>
						</div>
					</div>
				</div>
				<div class="flex flex-col gap-4 w-full card rounded-xl p-5">
					<Text weight="medium" colorType="primary">{t('common.order_summary')}</Text>
					<div class="flex flex-col gap-1.5 w-full">
						<div class="flex flex-row justify-between">
							<Text>{t(`classtype.${booking.classTypeId}`)}</Text>
							<Text colorType="primary">{t(`common.${booking.payment.currency.toLowerCase()}_price`, { amount: booking.payment.amount.toFixed(2) })}</Text>
						</div>
						<Divider />
						<div class="flex flex-row justify-between">
								<Text>{t('common.total')}</Text>
								<Text weight="medium" size="text-lg" colorType="primary">{t(`common.${booking.payment.currency.toLowerCase()}_price`, { amount: booking.payment.amount.toFixed(2) })}</Text>
						</div>
					</div>
				</div>
			</div>
			<div class="flex flex-col w-full gap-5">
				<div class="flex flex-col w-full card rounded-xl p-5">
					<Text weight="medium" colorType="primary" className="mb-4">{t('common.payment_method')}</Text>
					<BookingCheckoutWrapper 
						clientSecret={booking.payment.clientSecret}
						amount={booking.payment.amount}
						currency={booking.payment.currency}
						lang={lang}
						client:load
					/>
				</div>
				<!-- <div class="flex w-full card rounded-xl p-5 h-[400px]">
					<Text weight="medium" colorType="primary">{t('reviews.students_say')}</Text>
				</div> -->
			</div>
		</div>
	</div>
</Main>
