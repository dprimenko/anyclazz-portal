---
import Main from '../layout/Main.astro';
import { Text } from '@/ui-library/components/ssr/text/Text';
import { useTranslations, getLangFromUrl } from '@/i18n';
import { Button } from '@/ui-library/components/ssr/button/Button';
import { Breadcrumb } from '@/ui-library/components/breadcrumb';
import { Space } from '@/ui-library/components/ssr/space/Space';
import { DateTime } from '@/features/shared/utils/dateConfig';
import { Avatar } from '@/ui-library/components/ssr/avatar/Avatar';
import { AnyclazzMyBookingsRepository } from '@/features/bookings/infrastructure/AnyclazzMyBookingsRepository';

const repository = new AnyclazzMyBookingsRepository();
const bookings = await repository.getUpcomingBookings(Astro.request);

export const prerender = false;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations({ lang });

// Mock clazzmate data
const clazzmate = {
    referralLink: 'anyclazz.nn.com/4060020',
    friendsInvited: 3,
    creditsEarned: 20.00
};

const upcomingLessons = bookings.slice(0, 5); // Take first 5 as upcoming lessons
---

<style>
	.dashboard__header-buttons {
		display: flex;
		gap: 0.75rem;
	}

	.dashboard__grid {
		display: grid;
		grid-template-columns: 1fr;
		gap: 2rem;
	}

	.dashboard__lessons-column {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	.dashboard__sidebar {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.section {
		background: white;
		border-radius: 0.75rem;
		padding: 1.5rem;
		box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
	}

	.section-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.section__view-all {
		text-decoration: none;
		transition: opacity 0.2s;
	}

	.section__view-all:hover {
		opacity: 0.7;
	}

	/* Mobile Cards Container */
	.dashboard__mobile-cards {
		width: 100%;
		overflow-x: auto;
		overflow-y: visible;
		-webkit-overflow-scrolling: touch;
		scrollbar-width: none;
		-ms-overflow-style: none;
	}

	.dashboard__mobile-cards::-webkit-scrollbar {
		display: none;
	}

	/* Cards Inner Wrapper */
	.dashboard__mobile-cards > * {
		display: flex;
		gap: 1rem;
		padding-bottom: 1rem;
		flex-wrap: nowrap;
	}

	.dashboard__lesson-card {
		min-width: 280px;
		max-width: 280px;
		flex-shrink: 0;
		background: white;
		border: 1px solid var(--color-neutral-200);
		border-radius: 0.75rem;
		padding: 1rem;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.dashboard__card-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		position: relative;
	}

	.dashboard__card-details {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	/* Table Styles */
	.dashboard__table {
		width: 100%;
		display: none;
	}

	.dashboard__table-header {
		display: grid;
		grid-template-columns: 2fr 1.5fr 1fr 1fr 100px;
		gap: 1rem;
		padding: 0.75rem 1rem;
		border-bottom: 1px solid var(--color-neutral-200);
	}

	.dashboard__table-row {
		display: grid;
		grid-template-columns: 2fr 1.5fr 1fr 1fr 100px;
		gap: 1rem;
		padding: 1rem;
		border-bottom: 1px solid var(--color-neutral-100);
		align-items: center;
	}

	.dashboard__table-row:last-child {
		border-bottom: none;
	}

	.dashboard__table-row:hover {
		background-color: var(--color-neutral-50);
	}

	.dashboard__col-1, .dashboard__col-2, .dashboard__col-3, .dashboard__col-4, .dashboard__col-5 {
		display: flex;
		align-items: center;
	}

	.dashboard__teacher {
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.dashboard__badge {
		padding: 0.25rem 0.75rem;
		border-radius: 9999px;
		font-size: 0.75rem;
		font-weight: 500;
	}

	.dashboard__badge--online {
		background-color: var(--color-accent-50);
		color: var(--color-accent-700);
	}

	.dashboard__badge--onsite {
		background-color: var(--color-info-50);
		color: var(--color-info-700);
	}

	.dashboard__actions {
		display: flex;
		gap: 0.5rem;
		justify-content: flex-end;
	}

	.dashboard__menu-wrapper {
		position: relative;
	}

	.dashboard__menu-button {
		padding: 0.5rem;
		border-radius: 0.375rem;
		background: transparent;
		border: none;
		cursor: pointer;
		color: var(--color-neutral-600);
		transition: all 0.2s;
	}

	.dashboard__menu-button:hover {
		background-color: var(--color-neutral-100);
	}

	.dashboard__dropdown {
		position: absolute;
		right: 0;
		top: calc(100% + 0.25rem);
		background: white;
		border-radius: 0.5rem;
		box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
		z-index: 10;
		min-width: 160px;
		padding: 0.5rem;
	}

	.dashboard__dropdown-item {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		width: 100%;
		padding: 0.75rem;
		border: none;
		background: transparent;
		cursor: pointer;
		border-radius: 0.375rem;
	}

	.dashboard__dropdown-item:hover {
		background-color: var(--color-neutral-50);
	}

	/* Clazzmate Card */
	.dashboard__clazzmate-card {
		background: white;
		border-radius: 0.75rem;
		padding: 1.5rem;
		box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
	}

	.dashboard__clazzmate-header {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin-bottom: 1rem;
	}

	.dashboard__clazzmate-icon {
		width: 40px;
		height: 40px;
		border-radius: 0.5rem;
		background: linear-gradient(135deg, var(--color-accent-500) 0%, var(--color-accent-600) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
	}

	.dashboard__referral-link {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.75rem;
		background-color: var(--color-neutral-50);
		border: 1px solid var(--color-neutral-200);
		border-radius: 0.5rem;
		margin-bottom: 1.5rem;
	}

	.dashboard__copy-button {
		padding: 0.5rem;
		border-radius: 0.375rem;
		background: white;
		border: 1px solid var(--color-neutral-200);
		cursor: pointer;
		display: flex;
		align-items: center;
		transition: all 0.2s;
	}

	.dashboard__copy-button:hover {
		background-color: var(--color-neutral-50);
	}

	.dashboard__clazzmate-stats {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1rem;
	}

	/* Saved Teachers */
	.dashboard__saved-teachers-section {
		background: white;
		border-radius: 0.75rem;
		padding: 1.5rem;
		box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
	}

	.dashboard__teachers-list {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.dashboard__saved-teacher {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 0.75rem;
		border-radius: 0.5rem;
		cursor: pointer;
	}

	.dashboard__saved-teacher:hover {
		background-color: var(--color-neutral-50);
	}

	.dashboard__online-dot {
		position: absolute;
		bottom: 0;
		right: 0;
		width: 10px;
		height: 10px;
		border-radius: 50%;
		background-color: var(--color-success-500);
		border: 2px solid white;
	}

	/* Responsive */
	@media (min-width: 1024px) {
		.dashboard__grid {
			grid-template-columns: 1fr 380px;
		}

		.dashboard__mobile-cards {
			display: none;
		}

		.dashboard__table {
			display: block;
		}
	}
</style>

<Main title="Dashboard">
    <!-- <DashboardContent 
        client:load
        userName="Olivia"
        upcomingLessons={upcomingLessons}
        lastLessons={lastLessons}
        savedTeachers={savedTeachers}
        clazzmate={clazzmate}
    /> -->

	<div class="px-4 py-2 sm:p-8">
		<Breadcrumb
			items={[
				{ label: t('menu.dashboard'), href: '/dashboard' },
			]}
		/>
		<Space size={16} direction="vertical" />
		<div class="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-4">
			<div class="flex-1 min-w-0">
				<!-- <Text textLevel="h3" size="display-xs" colorType="primary" weight="semibold">{t('dashboard.welcome_back', { name: `${mockTeacher.name} ${mockTeacher.surname}` })}</Text> -->
      			<Text textLevel="h4" colorType="tertiary">{t('dashboard.ready_to_continue')}</Text>
			</div>
			<div class="flex gap-[0.75rem] w-full md:w-auto md:flex-shrink-0">
				<Button 
					icon="calendar-plus" 
					label={t('dashboard.schedule_lesson')} 
					colorType="secondary"
					className="flex-1 md:flex-none"
				/>
				<Button 
					icon="search" 
					label={t('dashboard.find_teacher')} 
					colorType="primary"
					className="flex-1 md:flex-none"
				/>
			</div>
		</div>

		<div class="flex flex-col gap-2">
			{/* Left Column - Lessons */}
			<div class="flex flex-col gap-2">
				<section class="section">
					<div class="section__header">
						<Text textLevel="h2" size="text-lg" weight="semibold" colorType="primary">
							{t('dashboard.upcoming_lessons')}
						</Text>
						<a href="/me/upcoming-lessons" class="section__view-all">
							<Text size="text-sm" colorType="accent">
								{t('dashboard.view_all')}
							</Text>
						</a>
					</div>
					
					<!-- {/* Mobile Cards View */}
					<div className={styles.mobileCards}>
						<div>
						{upcomingLessons.map((lesson) => {
							const startTime = DateTime.fromISO(lesson.startAt);
							const endTime = DateTime.fromISO(lesson.endAt);
							const duration = endTime.diff(startTime, 'minutes').minutes;
							const price = lesson.teacher.classTypes[0]?.price?.amount || 0;
							
							return (
								<div key={lesson.id} className={styles.lessonCard}>
									<div className={styles.cardHeader}>
										<div className={styles.teacher}>
											<Avatar src={lesson.teacher.avatar} size={40} hasVerifiedBadge={lesson.teacher.isSuperTeacher} />
											<div>
												<Text size="text-sm" weight="semibold" colorType="primary">
													{lesson.teacher.name} {lesson.teacher.surname}
												</Text>
												<Text size="text-xs" colorType="tertiary">
													{lesson.teacher.subject.name.en}
												</Text>
											</div>
										</div>
										<PopMenu
											trigger={<Icon icon="more-vertical" iconWidth={20} iconHeight={20} />}
											items={[
												{
													icon: <Icon icon="chat" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.chat'),
													onClick: () => console.log('Chat')
												},
												{
													icon: <Icon icon="book" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.details'),
													onClick: () => openLessonDetails(lesson)
												},
												{
													icon: <Icon icon="trash-can" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.cancel_lesson'),
													onClick: () => console.log('Cancel lesson')
												}
											]}
										/>
									</div>
									<div className={styles.cardDetails}>
										<Text size="text-sm" colorType="secondary" weight="medium">
											Class: {lesson.classType}
										</Text>
										<Text size="text-sm" colorType="secondary">
											Time: {duration} min
										</Text>
										<Text size="text-sm" colorType="secondary">
											Date: {startTime.toFormat('ccc h:mm a')}
										</Text>
										<Text size="text-sm" colorType="secondary">
											Mode: Group
										</Text>
										<Text size="text-sm" colorType="secondary">
											Price: €{price}
										</Text>
										<div className="flex items-center gap-2">
											<Text size="text-sm" colorType="secondary">Type:</Text>
											<span className={lesson.status === 'online' ? styles.badgeOnline : styles.badgeOnsite}>
												{lesson.status === 'online' ? 'Online' : 'On-site'}
											</span>
										</div>
									</div>
									<Button label="Join" colorType="primary" fullWidth />
								</div>
							);
						})}
						</div>
					</div>

					-->

					<div class={styles.table}>
						<div class={styles.tableHeader}>
							<Text size="text-xs" colorType="tertiary" className={styles.col1}>Teacher</Text>
							<Text size="text-xs" colorType="tertiary" className={styles.col2}>Class</Text>
							<Text size="text-xs" colorType="tertiary" className={styles.col3}>Date</Text>
							<Text size="text-xs" colorType="tertiary" className={styles.col4}>Type</Text>
							<div class={styles.col5}></div>
						</div>
						{upcomingLessons.map((lesson) => {
							const startTime = DateTime.fromISO(lesson.startAt);
							return (
								<div key={lesson.id} className={styles.tableRow}>
									<div class={styles.col1}>
										<div class={styles.teacher}>
											<Avatar src={lesson.teacher.avatar} size={40} hasVerifiedBadge={lesson.teacher.isSuperTeacher} />
											<div>
												<Text size="text-sm" weight="semibold" colorType="primary">{lesson.teacher.name} {lesson.teacher.surname}</Text>
												<Text size="text-xs" colorType="tertiary">{lesson.teacher.subject.name.en}</Text>
											</div>
										</div>
									</div>
									<div class={styles.col2}>
										<Text size="text-sm" colorType="secondary">{lesson.classType}</Text>
									</div>
									<div class={styles.col3}>
										<Text size="text-sm" colorType="secondary">{startTime.toFormat('ccc HH:mm')}</Text>
									</div>
									<div class={styles.col4}>
										<span className={lesson.status === 'online' ? styles.badgeOnline : styles.badgeOnsite}>
											{lesson.status === 'online' ? 'Online' : 'On-site'}
										</span>
									</div>
									<div class={styles.col5}>
										<div class={styles.actions}>
											<Button label={t('common.join')} colorType="primary" />
											{/* <PopMenu
												trigger={<Icon icon="more-vertical" iconWidth={20} iconHeight={20} />}
												items={[
													{
														icon: <Icon icon="chat" iconWidth={16} iconHeight={16} />,
														label: t('dashboard.chat'),
														onClick: () => console.log('Chat')
													},
													{
														icon: <Icon icon="book" iconWidth={16} iconHeight={16} />,
														label: t('dashboard.details'),
														onClick: () => openLessonDetails(lesson)
													},
													{
														icon: <Icon icon="trash-can" iconWidth={16} iconHeight={16} />,
														label: t('dashboard.cancel_lesson'),
														onClick: () => console.log('Cancel lesson')
													}
												]}
											/> */}
										</div>
									</div>
								</div>
							);
						})}
					</div>
				</section>

				{/* Last Lessons */}
				<section class="section">
					<div class="section__header">
						<Text textLevel="h2" size="text-lg" weight="semibold" colorType="primary">
							{t('dashboard.last_lessons')}
						</Text>
						<a href="/me/last-lessons" class="section__view-all">
							<Text size="text-sm" colorType="accent">
								{t('dashboard.view_all')}
							</Text>
						</a>
					</div>
					
					<!-- <div className={styles.mobileCards}>
						<div>
						{lastLessons.map((lesson) => {
							const startTime = DateTime.fromISO(lesson.startAt);
							const endTime = DateTime.fromISO(lesson.endAt);
							const duration = endTime.diff(startTime, 'minutes').minutes;
							const price = lesson.teacher.classTypes[0]?.price?.amount || 0;
							
							return (
								<div key={lesson.id} className={styles.lessonCard}>
									<div className={styles.cardHeader}>
										<div className={styles.teacher}>
											<Avatar src={lesson.teacher.avatar} size={40} hasVerifiedBadge={lesson.teacher.isSuperTeacher} />
											<div>
												<Text size="text-sm" weight="semibold" colorType="primary">
													{lesson.teacher.name} {lesson.teacher.surname}
												</Text>
												<Text size="text-xs" colorType="tertiary">
													{lesson.teacher.subject.name.en}
												</Text>
											</div>
										</div>
										<PopMenu
											trigger={<Icon icon="more-vertical" iconWidth={20} iconHeight={20} />}
											items={[
												{
													icon: <Icon icon="chat" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.chat'),
													onClick: () => console.log('Chat')
												},
												{
													icon: <Icon icon="book" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.details'),
													onClick: () => openLessonDetails(lesson)
												}
											]}
										/>
									</div>
									<div className={styles.cardDetails}>
										<Text size="text-sm" colorType="secondary" weight="medium">
											Class: {lesson.classType}
										</Text>
										<Text size="text-sm" colorType="secondary">
											Time: {duration} min
										</Text>
										<Text size="text-sm" colorType="secondary">
											Date: {startTime.toFormat('ccc h:mm a')}
										</Text>
										<Text size="text-sm" colorType="secondary">
											Mode: Group
										</Text>
										<Text size="text-sm" colorType="secondary">
											Price: €{price}
										</Text>
										<div className="flex items-center gap-2">
											<Text size="text-sm" colorType="secondary">Type:</Text>
											<span className={lesson.status === 'online' ? styles.badgeOnline : styles.badgeOnsite}>
												{lesson.status === 'online' ? 'Online' : 'On-site'}
											</span>
										</div>
									</div>
								</div>
							);
						})}
						</div>
					</div> -->

					<!-- <div className={styles.table}>
						<div className={styles.tableHeader}>
							<Text size="text-xs" colorType="tertiary" className={styles.col1}>Teacher</Text>
							<Text size="text-xs" colorType="tertiary" className={styles.col2}>Class</Text>
							<Text size="text-xs" colorType="tertiary" className={styles.col3}>Date</Text>
							<Text size="text-xs" colorType="tertiary" className={styles.col4}>Type</Text>
							<div className={styles.col5}></div>
						</div>
						{lastLessons.map((lesson) => {
							const startTime = DateTime.fromISO(lesson.startAt);
							return (
								<div key={lesson.id} className={styles.tableRow}>
									<div className={styles.col1}>
										<div className={styles.teacher}>
											<Avatar src={lesson.teacher.avatar} size={40} hasVerifiedBadge={lesson.teacher.isSuperTeacher} />
											<div>
												<Text size="text-sm" weight="semibold" colorType="primary">{lesson.teacher.name} {lesson.teacher.surname}</Text>
												<Text size="text-xs" colorType="tertiary">{lesson.teacher.subject.name.en}</Text>
											</div>
										</div>
									</div>
									<div className={styles.col2}>
										<Text size="text-sm" colorType="secondary">{lesson.classType}</Text>
									</div>
									<div className={styles.col3}>
										<Text size="text-sm" colorType="secondary">{startTime.toFormat('ccc HH:mm')}</Text>
									</div>
									<div className={styles.col4}>
										<span className={lesson.status === 'online' ? styles.badgeOnline : styles.badgeOnsite}>
											{lesson.status === 'online' ? 'Online' : 'On-site'}
										</span>
									</div>
									<div className={styles.col5}>
										<PopMenu
											trigger={<Icon icon="more-vertical" iconWidth={20} iconHeight={20} />}
											items={[
												{
													icon: <Icon icon="chat" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.chat'),
													onClick: () => console.log('Chat')
												},
												{
													icon: <Icon icon="book" iconWidth={16} iconHeight={16} />,
													label: t('dashboard.details'),
													onClick: () => openLessonDetails(lesson)
												}
											]}
										/>
									</div>
								</div>
							);
						})}
					</div> -->
				</section>
			</div>

			<!-- <div className={styles.sidebar}>
				<section className={styles.clazzmateCard}>
					<div className={styles.clazzmateHeader}>
						<div className={styles.clazzmateIcon}>
							<Icon icon="access" iconWidth={20} iconHeight={20} />
						</div>
						<Text textLevel="h3" size="text-lg" weight="semibold" colorType="primary">
							Clazzmate
						</Text>
					</div>
					
					<Text size="text-sm" colorType="tertiary" className="mb-4">
						{t('clazzmate.invite_earn')}
					</Text>
					<Text size="text-xs" colorType="tertiary" className="mb-4">
						{t('clazzmate.description')}
					</Text>

					<div className={styles.referralLink}>
						<Text size="text-sm" colorType="secondary" className="flex-1 truncate">
							{clazzmate.referralLink}
						</Text>
						<button onClick={handleCopyLink} className={styles.copyButton}>
							<Icon icon={copied ? "check" : "copy"} iconWidth={16} iconHeight={16} />
						</button>
					</div>

					<div className={styles.clazzmateStats}>
						<div>
							<Text size="text-xs" colorType="tertiary">{t('clazzmate.friends_invited')}</Text>
							<Text size="text-xl" weight="semibold" colorType="primary" className="mt-1">{clazzmate.friendsInvited}</Text>
						</div>
						<div>
							<Text size="text-xs" colorType="tertiary">{t('clazzmate.credits_earned')}</Text>
							<Text size="text-xl" weight="semibold" colorType="primary" className="mt-1">€{clazzmate.creditsEarned.toFixed(2)}</Text>
						</div>
					</div>
				</section>

				<section className={styles.savedTeachersSection}>
					<div className={styles.sectionHeader}>
						<Text textLevel="h3" size="text-lg" weight="semibold" colorType="primary">
							{t('dashboard.saved_teachers')}
						</Text>
						<a href="/me/saved-teachers" className={styles.viewAll}>
							<Text size="text-sm" colorType="accent">
								{t('dashboard.view_all')}
							</Text>
						</a>
					</div>
					
					<div className={styles.teachersList}>
						{savedTeachers.map((teacher) => (
							<div key={teacher.id} className={styles.savedTeacher}>
								<div className="relative">
									<Avatar src={teacher.avatar} size={40} hasVerifiedBadge={teacher.isSuperTeacher} />
									{teacher.isOnline && <div className={styles.onlineDot} />}
								</div>
								<div className="flex-1 min-w-0">
									<Text size="text-sm" weight="semibold" colorType="primary" className="truncate">
										{teacher.name} {teacher.surname}
									</Text>
									<Text size="text-xs" colorType="tertiary" className="truncate">
										{teacher.subject.name.en}
									</Text>
								</div>
							</div>
						))}
					</div>
				</section>
			</div> -->
		</div>

		<!-- {selectedLesson && (
			<LessonDetailsModal
				lesson={selectedLesson}
				onClose={closeLessonDetails}
				onCancel={() => {
					console.log('Cancel lesson');
					closeLessonDetails();
				}}
				onSendMessage={() => {
					console.log('Send message');
					closeLessonDetails();
				}}
				onJoin={() => {
					console.log('Join lesson');
					closeLessonDetails();
				}}
			/>
		)} -->
	</div>
</Main>
