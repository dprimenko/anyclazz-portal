---
import './styles.css'
import { AnyclazzAuthRepository } from "../../infrastructure/AnyclazzAuthRepository"

const loggedUser = new AnyclazzAuthRepository();
const user = await loggedUser.getCurrentUser(Astro.request);
---

<div class="logged-user">
    {user && (
        <div class="logged-user__container">
            <span class="logged-user__name">{user.name}</span>
            <button 
                class="logged-user__logout-btn" 
                id="logout-btn"
            >
                Cerrar sesi√≥n
            </button>
        </div>
    )}
</div>

<script>
    const logoutBtn = document.getElementById('logout-btn');
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            console.log('üö™ Logout button clicked');
            
            try {
                // Primero llamar a signOut de auth-astro para limpiar la sesi√≥n local
                const { signOut } = await import("auth-astro/client");
                console.log('üîì Calling signOut...');
                await signOut();
                
                // Despu√©s redirigir al logout de Keycloak
                console.log('‚û°Ô∏è  Redirecting to Keycloak logout...');
                window.location.href = '/api/auth/keycloak-logout';
            } catch (error) {
                console.error('‚ùå Error during logout:', error);
                // Si falla signOut, intentar ir directamente al endpoint
                window.location.href = '/api/auth/keycloak-logout';
            }
        });
    }
</script>